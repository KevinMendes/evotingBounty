ARG DOCKER_REGISTRY
FROM $DOCKER_REGISTRY/ev/tomee:8

WORKDIR $CATALINA_HOME

COPY ./resources/server_*.xml ./conf/server.xml
COPY ./resources/tomee_*.xml ./conf/tomee.xml
COPY ./orchestrator-main/target/or-ws-rest.war ./webapps/or-ws-rest.war

ENV TC_HTTP_PORT=8010 \
 DEBUG_PORT=6010 \
 APP_CONTEXT=or-ws-rest

RUN chown evote:evote -R /data/appl

# REST TIME OUT PROPERTIES
ENV READ_TIME_OUT=60
ENV WRITE_TIME_OUT=60
ENV CONNECTION_TIME_OUT=60

# CRYPTO POOLS PROPERTIES
ENV ASYMMETRIC_MAX_ELEMENTS_CRYPTO_POOL=50
ENV PROOFS_MAX_ELEMENTS_CRYPTO_POOL=50
ENV PRIMITIVES_MAX_ELEMENTS_CRYPTO_POOL=50
ENV ELGAMAL_MAX_ELEMENTS_CRYPTO_POOL=50
ENV STORES_MAX_ELEMENTS_CRYPTO_POOL=50
ENV SYMMETRIC_MAX_ELEMENTS_CRYPTO_POOL=50

ENV DECRYPT_POLLING_TIMEOUT_MS=40000
ENV DECRYPT_INTER_POLLS_DELAY_MS=200
ENV COMPUTE_POLLING_TIMEOUT_MS=20000
ENV COMPUTE_INTER_POLLS_DELAY_MS=200
ENV CHOICE_CODES_KEY_GENERATION_POLLING_TIMEOUT_MS=40000
ENV CHOICE_CODES_KEY_GENERATION_INTER_POLLS_DELAY_MS=200

USER evote
ENV JAVA_OPTS="-Dorg.apache.johnzon.max-string-length=262144"

EXPOSE ${TC_HTTP_PORT} ${DEBUG_PORT}
CMD ./bin/catalina.sh run
HEALTHCHECK --timeout=3s --retries=4 CMD curl --noproxy localhost -fk http://localhost:${TC_HTTP_PORT}/${APP_CONTEXT}/check || exit 1
